<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Details - BookCrossing</title>
        <link rel="website icon" type="png" href="Assets/logo icon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #fff;
            font-family: 'Poppins', sans-serif;
        }

        /* Navbar */
        .navbar-brand {
            font-weight: bold;
            color: #000;
        }

        .navbar-nav a {
            color: #000 !important;
            font-weight: 500;
            margin: 0 10px;
        }

        /* Book section */
        .book-section {
            margin-top: 60px;
        }

        /* Default images styling */
        .book-img {
            width: 220px;
            height: 300px;
            border-radius: 10px;
            object-fit: cover;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #6c757d;
        }

        .owner-image,
        .reviewer-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .reviewer-image {
            width: 60px;
            height: 60px;
        }

        .book-details h3 {
            font-weight: 700;
        }

        .book-details p {
            margin: 2px 0;
            font-size: 15px;
        }

        .rating i {
            color: #FFD700;
        }

        .borrow-btn {
            background-color: #FFD700;
            color: #000;
            border: none;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 20px;
        }

        /* Reviews */
        .review-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .review-user img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .review-stars i {
            color: #FFD700;
        }

        /* Footer */
        footer {
            background-color: #f6f6f6;
            padding: 40px 0;
            margin-top: 60px;
            color: #000;
        }

        footer h6 {
            font-weight: 700;
        }

        footer a {
            color: #000;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .social-icons i {
            font-size: 22px;
            margin: 0 8px;
            color: #000;
        }

        .social-icons i:hover {
            color: #FFD700;
        }

        .review-input textarea {
            resize: none;
            border-radius: 10px;
        }

        .submit-btn {
            background-color: #FFD700;
            color: #000;
            font-weight: 600;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
        }

        .chat-icon {
            position: fixed;
            bottom: 40px;
            right: 40px;
            background-color: #FFD700;
            border-radius: 50%;
            padding: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .action-buttons .btn {
            border-radius: 20px;
            font-weight: 600;
            padding: 10px 20px;
        }

        .owner-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white shadow-sm py-3">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html"><i class="fas fa-book-exchange me-2"></i>BookCrossing</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a href="browser-book.html" class="nav-link">Browse Books</a></li>
                    <li class="nav-item"><a href="my-books.html" class="nav-link">My Books</a></li>
                    <li class="nav-item"><a href="requests.html" class="nav-link">Requests</a></li>
                </ul>
            </div>
            <div>
                <a href="dashboard.html" class="btn btn-outline-dark me-2">
                    <i class="fas fa-home me-1"></i> Dashboard
                </a>
                <a href="add-book.html" class="btn btn-warning text-dark fw-bold rounded-pill px-3">
                    <i class="fas fa-plus me-1"></i> Add Book
                </a>
            </div>
        </div>
    </nav>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="container text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading book details...</p>
    </div>

    <!-- Book Details Content -->
    <div id="bookContent" class="container book-section" style="display: none;">
        <div class="row align-items-start">
            <!-- Book Image & Basic Info -->
            <div class="col-md-3 text-center">
<img src="https://via.placeholder.com/220x300/4A90E2/FFFFFF?text=Book+Image" 
     alt="Book" 
     class="book-img" 
     id="mainBookImage"
     onerror="this.src='https://via.placeholder.com/220x300/4A90E2/FFFFFF?text=Book+Image'">
            </div>

            <!-- Book Details -->
            <div class="col-md-6 book-details">
                <h3 id="bookTitle">The Forty Rules of Love</h3>

                <!-- Owner Info -->
                <div class="d-flex align-items-center mb-2">
                    <img src="https://via.placeholder.com/40/FFD700/000000?text=U" 
     class="rounded-circle me-2" 
     width="40" height="40" 
     id="ownerImage"
     onerror="this.src='https://via.placeholder.com/40/FFD700/000000?text=U'">
                    <span class="fw-semibold" id="ownerName">Book Owner Name</span>
                    <span class="badge owner-badge ms-2">Owner</span>
                </div>

                <!-- Rating -->
                <div class="rating mb-2">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <span class="ms-2" id="averageRating">(0 reviews)</span>
                </div>

                <!-- Book Information -->
                <p><strong>Author:</strong> <span id="bookAuthor">Elif Shafak</span></p>
                <p><strong>Genre:</strong> <span id="bookGenre">Fiction, Spirituality, Historical</span></p>
                <p><strong>Condition:</strong> <span id="bookCondition">New</span></p>
                <p><strong>ISBN:</strong> <span id="bookIsbn">Not available</span></p>
                <p><strong>Language:</strong> English</p>
                <p><strong>Owner's Location:</strong> <span id="bookLocation">Pakistan</span></p>
                <p><strong>Availability Status:</strong> <span id="bookStatus">Available</span></p>

                <!-- Book Description -->
                <div class="mt-3">
                    <h6><strong>Description</strong></h6>
                    <p id="bookDescription">This book touched my soul in ways I didn't expect. It beautifully connects
                        the past and present through the power of love and spirituality.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="col-md-3">
                <div class="action-buttons">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning btn-lg" onclick="openRequestModal()">
                            <i class="fas fa-handshake me-2"></i>Borrow Now
                        </button>
                        <button class="btn btn-outline-primary btn-lg" onclick="openMessageModal()">
                            <i class="fas fa-envelope me-2"></i>Message Owner
                        </button>
                        <button class="btn btn-outline-info" onclick="shareBook()">
                            <i class="fas fa-share-alt me-2"></i>Share Book
                        </button>
                    </div>

                    <!-- Quick Stats -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6>Book Statistics</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="fw-bold text-primary" id="totalRequests">0</div>
                                <small>Total Requests</small>
                            </div>
                            <div class="col-6">
                                <div class="fw-bold text-success" id="successfulExchanges">0</div>
                                <small>Successful Exchanges</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Input -->
        <div class="mt-5">
            <h6><strong>Add Your Review</strong></h6>
            <div class="review-box d-flex align-items-start">
<img src="https://via.placeholder.com/50/4A90E2/FFFFFF?text=U" 
     alt="user" 
     class="me-3" 
     width="50" height="50"
     onerror="this.src='https://via.placeholder.com/50/4A90E2/FFFFFF?text=U'">
                <div class="flex-grow-1">
                    <textarea rows="2" class="form-control review-input mb-2" placeholder="Write your review..."
                        id="reviewText"></textarea>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="rating-input">
                            <i class="bi bi-star rating-star" data-rating="1"></i>
                            <i class="bi bi-star rating-star" data-rating="2"></i>
                            <i class="bi bi-star rating-star" data-rating="3"></i>
                            <i class="bi bi-star rating-star" data-rating="4"></i>
                            <i class="bi bi-star rating-star" data-rating="5"></i>
                            <span class="ms-2" id="selectedRatingText">Select rating</span>
                        </div>
                        <button class="submit-btn" onclick="submitReview()">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Reviews -->
        <div class="mt-4">
            <h6><strong>Borrower's Reviews</strong></h6>
            <div id="reviewsContainer">
                <!-- Reviews will be loaded here dynamically -->
                <div class="d-flex mb-3">
                  <img src="https://via.placeholder.com/60/4A90E2/FFFFFF?text=U" 
                 alt="user" 
                 width="60" height="60" 
                 class="rounded-circle me-3"
                 onerror="this.src='https://via.placeholder.com/60/4A90E2/FFFFFF?text=U'">  
                    <div>
                        <h6 class="mb-0 fw-bold">Laila Adam
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-half text-warning"></i>
                        </h6>
                        <small class="text-secondary">Karachi</small>
                        <p class="mt-2 mb-0 small">
                            This book touched my soul in ways I didn't expect.<br>
                            It beautifully connects the past and present through the power of love and spirituality.<br>
                            The wisdom in Shams's forty rules made me reflect on life deeply.<br>
                            A truly heart-opening and unforgettable read.
                        </p>
                        <small class="text-secondary">22/March/2025</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request This Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="mb-3">
                            <label class="form-label">Request Type *</label>
                            <select class="form-select" name="request_type" required>
                                <option value="">Select type</option>
                                <option value="Borrow">Borrow</option>
                                <option value="Swap">Swap (Exchange with your book)</option>
                            </select>
                        </div>
                        <div class="mb-3" id="swapBookSection" style="display: none;">
                            <label class="form-label">Select Your Book for Swap</label>
                            <select class="form-select" name="swap_book_id" id="swapBookSelect">
                                <option value="">Choose your book</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message to Owner</label>
                            <textarea class="form-control" name="message" rows="3"
                                placeholder="Introduce yourself and explain why you want this book..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Proposed Return Date (for borrowing)</label>
                            <input type="date" class="form-control" name="proposed_return_date"
                                min="<?php echo date('Y-m-d', strtotime('+1 day')); ?>">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitRequest()">Send Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Message Book Owner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="messageForm">
                        <div class="mb-3">
                            <label class="form-label">Message *</label>
                            <textarea class="form-control" name="message" rows="4"
                                placeholder="Write your message to the book owner..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="sendMessage()">Send Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat icon -->
    <div class="chat-icon">
        <i class="bi bi-chat-dots fs-4"></i>
    </div>

    <!-- Footer -->
    <footer class="text-center text-md-start">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <p><strong>"Thank you for being a part of our story-sharing family—</strong><br>every book you share
                        brings knowledge, kindness, and connection to someone new.</p>
                </div>
                <div class="col-md-2 mb-3">
                    <h6>About</h6>
                    <a href="#">Contact Us</a><br>
                    <a href="#">About Us</a>
                </div>
                <div class="col-md-3 mb-3">
                    <h6>Services</h6>
                    <a href="browser-book.html">Browse Books</a><br>
                    <a href="#">Favorite Books</a>
                </div>
                <div class="col-md-2 mb-3">
                    <h6>Policies</h6>
                    <a href="#">Terms & Conditions</a>
                </div>
                <div class="col-md-3 mb-3">
                    <h6>Got In Touch</h6>
                    <p class="mb-1">bookcrossing@gmail.com</p>
                    <p class="mb-1">Bookcrossing.com</p>
                    <p>+92 3412875468</p>
                </div>
            </div>
            <hr>
            <div class="d-flex justify-content-between align-items-center">
                <p class="mb-0">&copy; 2025 BookCrossing, Inc. All rights reserved.</p>
                <div class="social-icons">
                    <i class="bi bi-facebook"></i>
                    <i class="bi bi-tiktok"></i>
                    <i class="bi bi-instagram"></i>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost/book-exchange/backend/api';
        let currentBookId = null;
        let currentOwnerId = null;
        let userBooks = [];
        let selectedRating = 0;

        // URL se book ID get karna
        function getBookIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Page load par book details load karna
        document.addEventListener('DOMContentLoaded', function () {
            currentBookId = getBookIdFromURL();
            if (currentBookId) {
                loadBookDetails(currentBookId);
                loadBookReviews(currentBookId);
                loadUserBooks();
                setupRatingStars();
                setupRequestTypeListener();
            } else {
                showError('Book ID not specified');
            }
        });

        // Book details load karna
        async function loadBookDetails(bookId) {
            try {
                const response = await fetch(`${API_BASE}/books/read.php?id=${bookId}`);
                const data = await response.json();

                if (data.success && data.book) {
                    displayBookDetails(data.book);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('bookContent').style.display = 'block';
                } else {
                    showError('Book not found');
                }
            } catch (error) {
                console.error('Error loading book details:', error);
                showError('Error loading book details: ' + error.message);
            }
        }

        // Book details display karna
        function displayBookDetails(book) {
            document.getElementById('bookTitle').textContent = book.title;
            document.getElementById('bookAuthor').textContent = book.author;
            document.getElementById('bookDescription').textContent = book.description || 'No description available.';
            document.getElementById('bookGenre').textContent = book.genre || 'General';
            document.getElementById('bookCondition').textContent = book.condition;
            document.getElementById('bookStatus').textContent = book.status;
            document.getElementById('bookIsbn').textContent = book.isbn || 'Not available';
            document.getElementById('bookLocation').textContent = book.location || 'Not specified';

            // Owner details
            document.getElementById('ownerName').textContent = book.owner_name || 'Unknown';

            // Set book image - FIXED
            if (book.image_path) {
                document.getElementById('mainBookImage').src = book.image_path;
            } else {
                document.getElementById('mainBookImage').src = 'https://via.placeholder.com/220x300/4A90E2/FFFFFF?text=Book+Image';
            }

            // Set owner image - FIXED
            if (book.owner_profile_picture) {
                document.getElementById('ownerImage').src = book.owner_profile_picture;
            } else {
                document.getElementById('ownerImage').src = 'https://via.placeholder.com/40/FFD700/000000?text=U';
            }

            currentOwnerId = book.user_id;
        }

        // Reviews display karna - FIXED
        function displayReviews(reviews) {
            const container = document.getElementById('reviewsContainer');

            if (!reviews || reviews.length === 0) {
                container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <p class="text-muted">No reviews yet. Be the first to review this book!</p>
            </div>
        `;
                return;
            }

            container.innerHTML = reviews.map(review => `
        <div class="d-flex mb-3">
            <img src="${review.reviewer_profile_picture || 'https://via.placeholder.com/60/4A90E2/FFFFFF?text=U'}" 
                 alt="user" width="60" height="60" class="rounded-circle me-3">
            <div>
                <h6 class="mb-0 fw-bold">${review.reviewer_name}
                    ${getStarRatingHTML(review.rating)}
                </h6>
                <small class="text-secondary">${review.location || ''}</small>
                <p class="mt-2 mb-0 small">${review.comment || 'No comment provided.'}</p>
                <small class="text-secondary">${new Date(review.created_at).toLocaleDateString()}</small>
            </div>
        </div>
    `).join('');
        }
        // Reviews load karna
        async function loadBookReviews(bookId) {
            try {
                const response = await fetch(`${API_BASE}/books/get_reviews.php?book_id=${bookId}`);
                const data = await response.json();

                if (data.success) {
                    displayReviews(data.reviews);
                    updateRatingDisplay(data.average_rating, data.total_reviews);
                }
            } catch (error) {
                console.log('Reviews not available yet');
                displayReviews([]);
            }
        }

        // Reviews display karna
        function displayReviews(reviews) {
            const container = document.getElementById('reviewsContainer');

            if (!reviews || reviews.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No reviews yet. Be the first to review this book!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reviews.map(review => `
                <div class="d-flex mb-3">
                    <img src="${review.reviewer_profile_picture || 'https://i.ibb.co/f8sFbbZ/profile.png'}" 
                         alt="user" width="60" height="60" class="rounded-circle me-3">
                    <div>
                        <h6 class="mb-0 fw-bold">${review.reviewer_name}
                            ${getStarRatingHTML(review.rating)}
                        </h6>
                        <small class="text-secondary">${review.location || ''}</small>
                        <p class="mt-2 mb-0 small">${review.comment || 'No comment provided.'}</p>
                        <small class="text-secondary">${new Date(review.created_at).toLocaleDateString()}</small>
                    </div>
                </div>
            `).join('');
        }

        // Star rating HTML helper
        function getStarRatingHTML(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="bi bi-star-fill text-warning"></i>';
                } else {
                    stars += '<i class="bi bi-star text-warning"></i>';
                }
            }
            return stars;
        }

        // Average rating update karna
        function updateRatingDisplay(averageRating, totalReviews) {
            const stars = document.querySelectorAll('.rating .bi');
            const ratingText = document.getElementById('averageRating');

            // Reset stars
            stars.forEach(star => star.className = 'bi bi-star-fill');

            // Fill stars based on average rating
            const fullStars = Math.floor(averageRating);
            const halfStar = averageRating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                stars[i].className = 'bi bi-star-fill';
            }

            if (halfStar && fullStars < 5) {
                stars[fullStars].className = 'bi bi-star-half text-warning';
            }

            ratingText.textContent = `(${averageRating.toFixed(1)} • ${totalReviews} reviews)`;
        }

        // User ke books load karna
        async function loadUserBooks() {
            const userData = JSON.parse(localStorage.getItem('user'));
            if (!userData || !userData.user_id) return;

            try {
                const response = await fetch(`${API_BASE}/books/user_books.php?user_id=${userData.user_id}`);
                const data = await response.json();

                if (data.success) {
                    userBooks = data.books || [];
                    populateSwapBooks();
                }
            } catch (error) {
                console.log('User books not available yet');
                userBooks = [];
            }
        }

        // Swap books dropdown populate karna
        function populateSwapBooks() {
            const select = document.getElementById('swapBookSelect');
            select.innerHTML = '<option value="">Choose your book</option>';

            if (userBooks.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No available books for swap";
                option.disabled = true;
                select.appendChild(option);
            } else {
                userBooks.forEach(book => {
                    if (book.status === 'Available') {
                        const option = document.createElement('option');
                        option.value = book.id;
                        option.textContent = `${book.title} by ${book.author}`;
                        select.appendChild(option);
                    }
                });
            }
        }

        // Rating stars setup
        function setupRatingStars() {
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', function () {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    setRating(rating);
                });
            });
        }

        function setRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                if (index < rating) {
                    star.className = 'bi bi-star-fill rating-star text-warning';
                } else {
                    star.className = 'bi bi-star rating-star text-warning';
                }
            });
            document.getElementById('selectedRatingText').textContent = `${rating} star${rating > 1 ? 's' : ''}`;
        }

        // Request type listener setup
        function setupRequestTypeListener() {
            document.querySelector('select[name="request_type"]').addEventListener('change', function () {
                const swapSection = document.getElementById('swapBookSection');
                swapSection.style.display = this.value === 'Swap' ? 'block' : 'none';
            });
        }

        // Request modal open karna
        function openRequestModal() {
            const userData = JSON.parse(localStorage.getItem('user'));
            if (!userData || !userData.loggedIn) {
                alert('Please login first to request a book');
                window.location.href = 'login.html';
                return;
            }

            if (userData.user_id === currentOwnerId) {
                alert('You cannot request your own book');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('requestModal'));
            modal.show();
        }

        // Message modal open karna
        function openMessageModal() {
            const userData = JSON.parse(localStorage.getItem('user'));
            if (!userData || !userData.loggedIn) {
                alert('Please login first to message the owner');
                window.location.href = 'login.html';
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            modal.show();
        }

        // Error display karna
        function showError(message) {
            document.getElementById('loadingSpinner').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                    <br><br>
                    <a href="browser-book.html" class="btn btn-primary">Back to Browse Books</a>
                </div>
            `;
        }

        // Share book functionality
        function shareBook() {
            const bookTitle = document.getElementById('bookTitle').textContent;
            const shareUrl = window.location.href;

            if (navigator.share) {
                navigator.share({
                    title: `Check out "${bookTitle}" on BookCrossing`,
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Book link copied to clipboard!');
                });
            }
        }

        // Submit request function
        async function submitRequest() {
            const form = document.getElementById('requestForm');
            const formData = new FormData(form);

            const userData = JSON.parse(localStorage.getItem('user'));
            if (!userData || !userData.user_id) {
                alert('Please login again');
                return;
            }

            const requestData = {
                book_id: currentBookId,
                user_id: userData.user_id,
                request_type: formData.get('request_type'),
                message: formData.get('message'),
                proposed_return_date: formData.get('proposed_return_date') || null,
                swap_book_id: formData.get('swap_book_id') || null
            };

            try {
                const response = await fetch(`${API_BASE}/requests/create.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Book request sent successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                    form.reset();
                } else {
                    alert('Error: ' + (result.message || 'Failed to send request'));
                }
            } catch (error) {
                console.error('Error sending request:', error);
                alert('Error sending request. Please try again.');
            }
        }

        // Send message function
        async function sendMessage() {
            const form = document.getElementById('messageForm');
            const formData = new FormData(form);

            const userData = JSON.parse(localStorage.getItem('user'));
            if (!userData || !userData.user_id) {
                alert('Please login again');
                return;
            }

            alert('Message functionality coming soon!');
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
            form.reset();
        }

        // Submit review function
        async function submitReview() {
            const reviewText = document.getElementById('reviewText').value;

            if (selectedRating === 0) {
                alert('Please select a rating');
                return;
            }

            const userData = JSON.parse(localStorage.getItem('user'));
            if (!userData || !userData.user_id) {
                alert('Please login to submit a review');
                return;
            }

            alert('Review functionality coming soon!');
            document.getElementById('reviewText').value = '';
            setRating(0);
        }
    </script>
</body>

</html>