<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BookCrossing - Book Details</title>
    <link rel="website icon" type="png" href="Assets/logo icon.png" />

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fffdf8;
        }

        /* Navbar */
        .navbar {
            background-color: #f8f9fa;
        }

        .navbar-brand img {
            height: 40px;
        }

        .book-section {
            padding: 60px 0;
        }

        .book-img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .book-details h3 {
            font-weight: 700;
            color: #333;
        }

        .owner-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .owner-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #f8ca30;
        }

        .rating i {
            color: gold;
        }

        .action-buttons {
            margin-top: 25px;
        }

        .borrow-btn {
            background-color: #f8ca30;
            border: none;
            font-weight: 600;
            padding: 10px 30px;
            border-radius: 25px;
            transition: 0.3s;
            margin-right: 10px;
        }

        .borrow-btn:hover {
            background-color: #e0b420;
            transform: translateY(-2px);
        }

        .message-btn {
            background-color: #007bff;
            color: white;
            border: none;
            font-weight: 600;
            padding: 10px 30px;
            border-radius: 25px;
            transition: 0.3s;
        }

        .message-btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .review-section {
            margin-top: 50px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .review-input {
            display: flex;
            align-items: start;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .review-input img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .star-rating i {
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s;
            font-size: 1.2rem;
            margin-right: 5px;
        }

        .star-rating i.active {
            color: gold;
        }

        .review-card {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            background: white;
        }

        .review-card .reviewer {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .review-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .book-meta {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .book-meta p {
            margin-bottom: 8px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-borrowed {
            background: #fff3cd;
            color: #856404;
        }

        .status-reserved {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Avatar Styles */
        .avatar-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .avatar-primary {
            background-color: #007bff;
        }

        .avatar-success {
            background-color: #28a745;
        }

        .avatar-warning {
            background-color: #ffc107;
            color: #000;
        }

        .avatar-danger {
            background-color: #dc3545;
        }

        /* Rating Stars */
        .star-rating i {
            color: #ccc;
            cursor: pointer;
            transition: color 0.3s;
            font-size: 1.2rem;
            margin-right: 2px;
        }

        .star-rating i.active {
            color: gold;
        }

        .star-rating i:hover {
            color: gold;
        }

        footer {
            background-color: #f7f7f7;
            padding: 40px 0;
            margin-top: 60px;
            font-size: 14px;
        }

        .image-gallery {
            margin-top: 20px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s;
        }

        .thumbnail.active {
            border-color: #f8ca30;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg px-4">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <img src="Assets/main logo.png" alt="main-logo" style="width:150px; margin-right:100px;">
        </a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-3">
                <li class="nav-item"><a href="browse-book.html" class="nav-link">Browse Book</a></li>
                <li class="nav-item"><a href="About-us.html" class="nav-link">About Us</a></li>
                <li class="nav-item"><a href="#" class="nav-link">Contact</a></li>
                <li class="nav-item"><a href="login.html" class="nav-link">Log In</a></li>
                <li class="nav-item"><a href="#" class="nav-link">Register / Sign Up</a></li>
            </ul>
        </div>
        <div class="d-flex">
            <a href="add-book.html" class="btn btn-warning">
                <i class="fas fa-plus me-1"></i> Add Book
            </a>
        </div>
    </nav>

    <!-- Book Section -->
    <section class="book-section container">
        <div class="row g-5">
            <div class="col-md-4">
                <img id="mainBookImage" src="" class="book-img" alt="Book Image">

                <!-- Image Gallery -->
                <div class="image-gallery d-flex justify-content-center">
                    <img id="thumb1" class="thumbnail" src="" alt="Thumbnail 1" onclick="changeMainImage(this.src)">
                    <img id="thumb2" class="thumbnail" src="" alt="Thumbnail 2" onclick="changeMainImage(this.src)">
                    <img id="thumb3" class="thumbnail" src="" alt="Thumbnail 3" onclick="changeMainImage(this.src)">
                </div>
            </div>

            <div class="col-md-8 book-details">
                <h3 id="bookTitle">Loading...</h3>

                <div class="owner-info">
                    <img id="ownerAvatar" src="Assets/user-avatar.png" alt="Owner">
                    <div>
                        <strong id="ownerName">Loading...</strong><br>
                        <small class="text-muted" id="ownerLocation">Location loading...</small>
                    </div>
                </div>

                <div class="rating mb-2" id="bookRating">
                    <!-- Rating stars will be dynamically generated -->
                </div>

                <div class="book-meta">
                    <p><strong>Author:</strong> <span id="bookAuthor">Loading...</span></p>
                    <p><strong>Genre:</strong> <span id="bookGenre">Loading...</span></p>
                    <p><strong>Condition:</strong> <span id="bookCondition">Loading...</span></p>
                    <p><strong>ISBN:</strong> <span id="bookISBN">Loading...</span></p>
                    <p><strong>Description:</strong> <span id="bookDescription">Loading...</span></p>
                    <p><strong>Availability Status:</strong>
                        <span id="bookStatus" class="status-badge">Loading...</span>
                    </p>
                </div>

                <div class="action-buttons">
                    <button class="borrow-btn" onclick="requestBorrow()">
                        <i class="fas fa-hand-holding me-1"></i> Request to Borrow
                    </button>
                    <button class="message-btn" onclick="messageOwner()">
                        <i class="fas fa-comment me-1"></i> Message Owner
                    </button>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="review-section">
            <h5 class="mb-4 fw-semibold">Reader's Reviews & Ratings</h5>

            <!-- Review Input Form -->
            <div class="review-input" id="reviewForm">
                <img id="userAvatar" src="Assets/user-avatar.png" alt="user">
                <div class="flex-grow-1">
                    <textarea class="form-control" id="reviewText" rows="3"
                        placeholder="Share your thoughts about this book..."></textarea>
                    <div class="star-rating mt-2 mb-2" id="ratingInput">
                        <i class="fa-solid fa-star" data-rating="1"></i>
                        <i class="fa-solid fa-star" data-rating="2"></i>
                        <i class="fa-solid fa-star" data-rating="3"></i>
                        <i class="fa-solid fa-star" data-rating="4"></i>
                        <i class="fa-solid fa-star" data-rating="5"></i>
                    </div>
                    <button class="btn btn-warning btn-sm fw-semibold" onclick="submitReview()">
                        <i class="fas fa-paper-plane me-1"></i> Submit Review
                    </button>
                </div>
            </div>

            <!-- Reviews List -->
            <div id="reviewsList">
                <div class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading reviews...</span>
                    </div>
                    <p class="mt-2">Loading reviews...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ✅ REQUEST MODAL - book-details.html ke footer se pehle add karein -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="mb-3">
                            <label class="form-label">Request Type *</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="requestType" id="borrowRequest"
                                    value="Borrow" checked>
                                <label class="form-check-label" for="borrowRequest">
                                    <i class="fas fa-hand-holding me-1"></i> Borrow Book
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="requestType" id="swapRequest"
                                    value="Swap">
                                <label class="form-check-label" for="swapRequest">
                                    <i class="fas fa-exchange-alt me-1"></i> Swap Book
                                </label>
                            </div>
                        </div>

                        <!-- Swap Book Selection (Conditional) -->
                        <div class="mb-3" id="swapBookSection" style="display: none;">
                            <label class="form-label">Select Your Book for Swap *</label>
                            <select class="form-select" id="swapBookSelect">
                                <option value="">Choose a book to swap...</option>
                            </select>
                            <small class="text-muted">Only your available books are shown</small>
                        </div>

                        <!-- Borrow Options -->
                        <div class="mb-3" id="borrowOptions">
                            <label class="form-label">Expected Return Date *</label>
                            <input type="date" class="form-control" id="returnDate" min="">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Message to Owner</label>
                            <textarea class="form-control" id="requestMessage" rows="3"
                                placeholder="Write a friendly message to the book owner..."></textarea>
                        </div>

                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                The owner will review your request and respond within 24 hours.
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitRequest()">
                        <i class="fas fa-paper-plane me-1"></i> Send Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ MESSAGE MODAL -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Message Book Owner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="messageForm">
                        <div class="mb-3">
                            <label class="form-label">To: <span id="receiverName" class="fw-bold"></span></label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">About Book: <span id="messageBookTitle"
                                    class="fw-bold text-primary"></span></label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Your Message *</label>
                            <textarea class="form-control" id="messageText" rows="4"
                                placeholder="Write your message to the book owner..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                The book owner will receive your message and can reply to you.
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane me-1"></i> Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="text-center text-md-start">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <img src="Assets/main logo.png" alt="logo" class="mb-3" style="height: 40px;">
                    <p>"Thank you for being a part of our story-sharing family— every book you share brings knowledge,
                        kindness, and connection to someone new."</p>
                </div>
                <div class="col-md-2">
                    <h6>About</h6>
                    <ul>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="About-us.html">About Us</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Services</h6>
                    <ul>
                        <li><a href="browse-book.html">Browse Books</a></li>
                        <li><a href="#">Favorite Books</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Got In Touch</h6>
                    <p class="mb-1">bookcrossing@gmail.com</p>
                    <p class="mb-1">Bookcrossing.com</p>
                    <p>+92 3412875468</p>
                    <div class="social-icons">
                        <i class="fab fa-facebook"></i>
                        <i class="fab fa-tiktok"></i>
                        <i class="fab fa-instagram"></i>
                    </div>
                </div>
            </div>
            <hr>
            <div class="text-center small">&copy; 2025 BookCrossing, Inc. All rights reserved.</div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ✅ GET BOOK ID FROM URL - YEH SABSE PEHLE
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');

        // ✅ GLOBAL VARIABLES
        let currentUserRating = 0;
        let currentUserId = null;
        let currentUser = null;

        console.log('Book ID from URL:', bookId);

        // ✅ CHECK IF BOOK ID EXISTS ON PAGE LOAD
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Page loaded, checking book ID:', bookId);

            if (!bookId) {
                showError('No book ID specified in URL. Please select a book from browse page.');
                return;
            }

            // Get current user
            getCurrentUser();

            // Load book data
            loadBookDetails(bookId);
            loadBookReviews(bookId);
            initializeRatingSystem();
        });

        // ✅ GET CURRENT USER FUNCTION
        function getCurrentUser() {
            try {
                const userData = JSON.parse(localStorage.getItem('user')) || null;
                if (userData && userData.user_id) {
                    currentUserId = userData.user_id;
                    currentUser = userData;

                    console.log('User logged in:', currentUser);

                    // Create avatar with user initial
                    const userInitial = (userData.name || 'U').charAt(0).toUpperCase();
                    const avatarColors = ['avatar-primary', 'avatar-success', 'avatar-warning', 'avatar-danger'];
                    const colorIndex = currentUserId % avatarColors.length;

                    document.getElementById('userAvatar').outerHTML = `
                <div class="avatar-placeholder ${avatarColors[colorIndex]}" id="userAvatar">
                    ${userInitial}
                </div>
            `;

                    return true;
                } else {
                    // User not logged in - hide review form
                    console.log('User not logged in, hiding review form');
                    document.getElementById('reviewForm').style.display = 'none';
                    return false;
                }
            } catch (error) {
                console.error('Error getting user data:', error);
                document.getElementById('reviewForm').style.display = 'none';
                return false;
            }
        }

        // ✅ LOAD BOOK DETAILS
        async function loadBookDetails(bookId) {
            try {
                console.log('Loading book details for ID:', bookId);

                const response = await fetch(`http://localhost/project/backend/api/books/read.php?id=${bookId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Book API Response:', data);

                if (data.books && data.books.length > 0) {
                    const book = data.books[0];
                    console.log('Book data:', book);
                    displayBookDetails(book);
                } else {
                    showError('Book not found in database');
                }
            } catch (error) {
                console.error('Error loading book details:', error);
                showError('Error loading book details: ' + error.message);
            }
        }

        // ✅ DISPLAY BOOK DETAILS
        function displayBookDetails(book) {
            console.log('Displaying book:', book);

            // Main book info
            document.getElementById('bookTitle').textContent = book.title || 'No Title';
            document.getElementById('bookAuthor').textContent = book.author || 'Unknown Author';
            document.getElementById('bookGenre').textContent = book.genre || 'Not specified';
            document.getElementById('bookCondition').textContent = book.condition || 'Not specified';
            document.getElementById('bookISBN').textContent = book.isbn || 'Not specified';
            document.getElementById('bookDescription').textContent = book.description || 'No description available';

            // Owner info
            const ownerName = book.owner_name || 'User ' + (book.user_id || 'Unknown');
            const ownerLocation = book.location || 'Location not specified';

            document.getElementById('ownerName').textContent = ownerName;
            document.getElementById('ownerLocation').textContent = ownerLocation;

            // Create owner avatar
            const ownerInitial = ownerName.charAt(0).toUpperCase();
            const avatarColors = ['avatar-primary', 'avatar-success', 'avatar-warning', 'avatar-danger'];
            const colorIndex = (book.user_id || 0) % avatarColors.length;

            document.getElementById('ownerAvatar').outerHTML = `
        <div class="avatar-placeholder ${avatarColors[colorIndex]}" id="ownerAvatar">
            ${ownerInitial}
        </div>
    `;

            // Status
            const statusElement = document.getElementById('bookStatus');
            const bookStatus = book.status || 'Unknown';
            statusElement.textContent = bookStatus;
            statusElement.className = 'status-badge ' + getStatusClass(bookStatus);

            // Images
            const images = [
                book.image_path,
                book.image_path2,
                book.image_path3
            ].filter(img => img && img.trim() !== '');

            console.log('Available images:', images);

            const mainImage = document.getElementById('mainBookImage');
            if (images.length > 0) {
                mainImage.src = images[0];
                mainImage.alt = book.title || 'Book Image';

                // Thumbnails
                for (let i = 0; i < 3; i++) {
                    const thumb = document.getElementById(`thumb${i + 1}`);
                    if (images[i]) {
                        thumb.src = images[i];
                        thumb.style.display = 'block';
                        thumb.alt = `Thumbnail ${i + 1}`;
                        if (i === 0) thumb.classList.add('active');

                        // Add error handling for thumbnails
                        thumb.onerror = function () {
                            this.style.display = 'none';
                        };
                    } else {
                        thumb.style.display = 'none';
                    }
                }
            } else {
                // No images available - show placeholder
                mainImage.src = 'Assets/default-book.jpg';
                mainImage.alt = 'No image available';

                // Hide all thumbnails
                for (let i = 1; i <= 3; i++) {
                    document.getElementById(`thumb${i}`).style.display = 'none';
                }
            }

            // Add error handling for main image
            mainImage.onerror = function () {
                this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="280" viewBox="0 0 200 280"><rect width="200" height="280" fill="%23f8f9fa"/><text x="100" y="140" text-anchor="middle" fill="%23666" font-family="Arial" font-size="16">No Image Available</text></svg>';
                this.alt = 'Image not available';
            };
        }

        // ✅ LOAD BOOK REVIEWS
        // ✅ LOAD BOOK REVIEWS - UPDATED VERSION
        async function loadBookReviews(bookId) {
            try {
                console.log('Loading reviews for book ID:', bookId);

                let reviews = [];

                // Try to load from API first
                try {
                    const response = await fetch(`http://localhost/project/backend/api/reviews/get_reviews.php?book_id=${bookId}`);

                    if (response.ok) {
                        const apiReviews = await response.json();
                        console.log('Reviews API Response:', apiReviews);
                        reviews = apiReviews;
                    } else {
                        throw new Error('API not available');
                    }
                } catch (apiError) {
                    console.error('Error loading reviews from API:', apiError);
                    // Fallback to localStorage reviews
                    reviews = loadReviewsFromLocalStorage(bookId);
                }

                displayReviews(reviews);

            } catch (error) {
                console.error('Error loading reviews:', error);
                // Final fallback to mock data
                const mockReviews = getMockReviews(bookId);
                displayReviews(mockReviews);
            }
        }

        // ✅ LOAD REVIEWS FROM LOCALSTORAGE
        function loadReviewsFromLocalStorage(bookId) {
            try {
                const localReviews = JSON.parse(localStorage.getItem('local_reviews') || '[]');
                const bookReviews = localReviews.filter(review => review.book_id == bookId);

                console.log('Loaded reviews from localStorage:', bookReviews);
                return bookReviews;
            } catch (error) {
                console.error('Error loading reviews from localStorage:', error);
                return [];
            }
        }

        // ✅ GET MOCK REVIEWS AS FINAL FALLBACK
        function getMockReviews(bookId) {
            const mockReviews = [
                {
                    id: 1,
                    user_name: "Laila Adam",
                    rating: 4.5,
                    comment: "This book touched my soul in ways I didn't expect. It beautifully connects the past and present through the power of love and spirituality.",
                    created_at: "2025-03-22"
                },
                {
                    id: 2,
                    user_name: "Ahmed Raza",
                    rating: 5,
                    comment: "Absolutely loved this book! The writing is beautiful and the story is very engaging.",
                    created_at: "2025-03-20"
                }
            ];

            return mockReviews;
        }

        // ✅ DISPLAY REVIEWS
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');

            if (!reviews || reviews.length === 0) {
                reviewsList.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-comments fa-2x mb-3"></i>
                <p>No reviews yet. Be the first to review this book!</p>
            </div>
        `;
                return;
            }

            reviewsList.innerHTML = reviews.map((review, index) => {
                const userInitial = (review.user_name || 'U').charAt(0).toUpperCase();
                const avatarColors = ['avatar-primary', 'avatar-success', 'avatar-warning', 'avatar-danger'];
                const colorIndex = index % avatarColors.length;

                return `
            <div class="review-card">
                <div class="reviewer">
                    <div class="avatar-placeholder ${avatarColors[colorIndex]}">
                        ${userInitial}
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0 fw-semibold">${review.user_name}</h6>
                        <small class="text-muted">${review.location || ''}</small><br>
                        <div class="rating">
                            ${generateStars(review.rating)}
                            <small class="text-muted ms-2">${review.rating}/5</small>
                        </div>
                    </div>
                    <div class="ms-auto small text-muted">${formatDate(review.created_at)}</div>
                </div>
                <p class="mt-2 mb-0">${review.comment}</p>
            </div>
        `;
            }).join('');
        }

        // ✅ INITIALIZE RATING SYSTEM
        function initializeRatingSystem() {
            const stars = document.querySelectorAll('#ratingInput i');

            stars.forEach(star => {
                star.addEventListener('click', function () {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    currentUserRating = rating;

                    console.log('User selected rating:', rating);

                    // Update star display
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                            s.style.color = 'gold';
                        } else {
                            s.classList.remove('active');
                            s.style.color = '#ccc';
                        }
                    });
                });
            });
        }

        // ✅ SUBMIT REVIEW
        async function submitReview() {
            if (!currentUserId) {
                alert('Please login to submit a review');
                window.location.href = 'login.html';
                return;
            }

            const reviewText = document.getElementById('reviewText').value.trim();

            if (!reviewText) {
                alert('Please write a review before submitting');
                return;
            }

            if (currentUserRating === 0) {
                alert('Please select a rating');
                return;
            }

            console.log('Submitting review:', {
                book_id: bookId,
                user_id: currentUserId,
                rating: currentUserRating,
                comment: reviewText
            });

            try {
                // Show loading state
                const submitBtn = document.querySelector('#reviewForm button');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Submitting...';
                submitBtn.disabled = true;

                // Prepare review data
                const reviewData = {
                    book_id: parseInt(bookId),
                    user_id: parseInt(currentUserId),
                    rating: parseInt(currentUserRating),
                    comment: reviewText
                };

                console.log('Sending review data:', reviewData);

                // Submit review to backend API
                const response = await fetch('http://localhost/project/backend/api/reviews/submit.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reviewData)
                });

                const result = await response.json();
                console.log('Review submission response:', result);

                if (response.ok) {
                    // Show success message
                    showSuccessMessage('Review submitted successfully!');

                    // Clear form
                    document.getElementById('reviewText').value = '';
                    currentUserRating = 0;
                    document.querySelectorAll('#ratingInput i').forEach(star => {
                        star.classList.remove('active');
                        star.style.color = '#ccc';
                    });

                    // Reload reviews to show the new one
                    setTimeout(() => {
                        loadBookReviews(bookId);
                    }, 1000);

                } else {
                    throw new Error(result.message || 'Failed to submit review');
                }

            } catch (error) {
                console.error('Error submitting review:', error);

                // Fallback to mock submission if API fails
                console.log('API failed, using fallback method');
                await submitReviewFallback(reviewText);

            } finally {
                // Reset button state
                const submitBtn = document.querySelector('#reviewForm button');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Submit Review';
                submitBtn.disabled = false;
            }
        }

        // ✅ FALLBACK METHOD IF API FAILS
        async function submitReviewFallback(reviewText) {
            try {
                // Store review in localStorage as fallback
                const reviewKey = `book_review_${bookId}_${currentUserId}`;
                const reviewData = {
                    id: Date.now(),
                    book_id: parseInt(bookId),
                    user_id: currentUserId,
                    user_name: currentUser.name || 'Current User',
                    rating: currentUserRating,
                    comment: reviewText,
                    created_at: new Date().toISOString()
                };

                localStorage.setItem(reviewKey, JSON.stringify(reviewData));

                // Also add to reviews list
                const reviewsList = JSON.parse(localStorage.getItem('local_reviews') || '[]');
                reviewsList.push(reviewData);
                localStorage.setItem('local_reviews', JSON.stringify(reviewsList));

                showSuccessMessage('Review submitted successfully! (Saved locally)');

                // Clear form
                document.getElementById('reviewText').value = '';
                currentUserRating = 0;
                document.querySelectorAll('#ratingInput i').forEach(star => {
                    star.classList.remove('active');
                    star.style.color = '#ccc';
                });

                // Reload reviews
                loadBookReviews(bookId);

            } catch (error) {
                console.error('Fallback submission failed:', error);
                alert('Error submitting review. Please try again.');
            }
        }

        // ✅ UTILITY FUNCTIONS
        function getStatusClass(status) {
            if (!status) return 'status-available';

            switch (status.toLowerCase()) {
                case 'available': return 'status-available';
                case 'borrowed': return 'status-borrowed';
                case 'reserved': return 'status-reserved';
                case 'lent out': return 'status-borrowed';
                default: return 'status-available';
            }
        }

        function generateStars(rating) {
            if (!rating) return '<i class="fa-regular fa-star"></i>'.repeat(5);

            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;

            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fa-solid fa-star"></i>';
            }

            if (hasHalfStar) {
                stars += '<i class="fa-solid fa-star-half-stroke"></i>';
            }

            const emptyStars = 5 - Math.ceil(rating);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="fa-regular fa-star"></i>';
            }

            return stars;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Recent';
            }
        }

        function changeMainImage(src) {
            const mainImage = document.getElementById('mainBookImage');
            if (mainImage && src) {
                mainImage.src = src;

                // Update active thumbnail
                document.querySelectorAll('.thumbnail').forEach(thumb => {
                    thumb.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }

        // ✅ REQUEST TYPE CHANGE HANDLER - IMPROVED VERSION
        // ✅ INITIALIZE REQUEST MODAL - IMPROVED
        function initializeRequestModal() {
            console.log('Initializing request modal...');

            // Request type change handler
            const requestTypeRadios = document.querySelectorAll('input[name="requestType"]');
            if (requestTypeRadios.length > 0) {
                requestTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function () {
                        const isSwap = this.value === 'Swap';
                        const swapSection = document.getElementById('swapBookSection');
                        const borrowSection = document.getElementById('borrowOptions');

                        if (swapSection) swapSection.style.display = isSwap ? 'block' : 'none';
                        if (borrowSection) borrowSection.style.display = isSwap ? 'none' : 'block';

                        if (isSwap) {
                            loadUserBooksForSwap();
                        }
                    });
                });
                console.log('Request type handlers initialized');
            }

            // Set minimum date for return (tomorrow)
            const returnDateInput = document.getElementById('returnDate');
            if (returnDateInput) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                returnDateInput.min = tomorrow.toISOString().split('T')[0];
                console.log('Return date min set to:', returnDateInput.min);
            }

            console.log('Request modal initialized successfully');
        }

        // ✅ REQUEST BORROW FUNCTION - UPDATE KAREN
        function requestBorrow() {
            console.log('Request borrow button clicked');

            if (!bookId) {
                alert('Book ID not found');
                return;
            }

            if (!currentUserId) {
                alert('Please login to request this book');
                window.location.href = 'login.html';
                return;
            }

            // Directly show modal - ownership check modal ke andar karenge
            showRequestModal();
        }

        // ✅ NEW FUNCTION TO SHOW MODAL DIRECTLY
        function showRequestModal() {
            console.log('Showing request modal');

            // Load user's books for swap options
            loadUserBooksForSwap();

            // Initialize modal events
            initializeRequestModal();

            // Set minimum date for return (tomorrow)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const returnDateInput = document.getElementById('returnDate');
            if (returnDateInput) {
                returnDateInput.min = tomorrow.toISOString().split('T')[0];
            }

            // Show modal using Bootstrap
            const requestModalElement = document.getElementById('requestModal');
            if (requestModalElement) {
                const requestModal = new bootstrap.Modal(requestModalElement);
                requestModal.show();
                console.log('Modal should be visible now');
            } else {
                console.error('Request modal element not found');
                alert('Error: Could not open request form');
            }
        }

        // ✅ CHECK IF USER'S OWN BOOK

        async function checkIfOwnBook() {
            try {
                const response = await fetch(`http://localhost/project/backend/api/books/read.php?id=${bookId}`);
                const data = await response.json();

                if (data.books && data.books.length > 0) {
                    const book = data.books[0];
                    if (book.user_id == currentUserId) {
                        alert("You cannot request your own book!");
                        return true; // Is own book
                    }
                    return false; // Not own book
                }
                return false;
            } catch (error) {
                console.error('Error checking book ownership:', error);
                // Continue anyway - don't block the user
                return false;
            }
        }


        // ✅ LOAD USER'S BOOKS FOR SWAP
        function loadUserBooksForSwap() {
            if (!currentUserId) return;

            fetch(`http://localhost/project/backend/api/books/read.php?user_id=${currentUserId}&status=Available`)
                .then(response => response.json())
                .then(data => {
                    const swapBookSelect = document.getElementById('swapBookSelect');
                    swapBookSelect.innerHTML = '<option value="">Choose a book to swap...</option>';

                    if (data.books && data.books.length > 0) {
                        data.books.forEach(book => {
                            const option = document.createElement('option');
                            option.value = book.id;
                            option.textContent = `${book.title} by ${book.author} (${book.condition})`;
                            swapBookSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No available books for swap";
                        option.disabled = true;
                        swapBookSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading user books:', error);
                });
        }

        // ✅ REQUEST TYPE CHANGE HANDLER
        document.addEventListener('DOMContentLoaded', function () {
            // Request type change handler
            document.querySelectorAll('input[name="requestType"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const isSwap = this.value === 'Swap';
                    document.getElementById('swapBookSection').style.display = isSwap ? 'block' : 'none';
                    document.getElementById('borrowOptions').style.display = isSwap ? 'none' : 'block';

                    if (isSwap) {
                        loadUserBooksForSwap();
                    }
                });
            });
        });

        // ✅ CHECK IF BOOK ID EXISTS ON PAGE LOAD - UPDATED
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Page loaded, checking book ID:', bookId);

            if (!bookId) {
                showError('No book ID specified in URL. Please select a book from browse page.');
                return;
            }

            // Get current user
            getCurrentUser();

            // Load book data
            loadBookDetails(bookId);
            loadBookReviews(bookId);
            initializeRatingSystem();

            // ✅ ADD THIS LINE - Pre-initialize modal
            initializeRequestModal();
        });

        // ✅ SUBMIT REQUEST FUNCTION
        // ✅ IMPROVED SUBMIT REQUEST FUNCTION - BETTER ERROR HANDLING
        async function submitRequest() {
            if (!currentUserId) {
                alert('Please login to send request');
                window.location.href = 'login.html';
                return;
            }

            const bookId = urlParams.get('id');
            if (!bookId) {
                alert('Book not found');
                return;
            }

            // Get form data
            const requestType = document.querySelector('input[name="requestType"]:checked').value;
            const message = document.getElementById('requestMessage').value.trim();

            if (!message) {
                alert('Please enter a message for your request');
                return;
            }

            // Prepare request data
            const requestData = {
                book_id: parseInt(bookId),
                user_id: currentUserId,
                request_type: requestType,
                message: message,
                proposed_return_date: requestType === 'Borrow' ?
                    document.getElementById('returnDate').value : null
            };

            console.log('Sending request:', requestData);

            const submitBtn = document.querySelector('#requestModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('http://localhost/project/backend/api/requests/create.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                // ✅ BETTER ERROR HANDLING - FIRST GET RAW RESPONSE
                const responseText = await response.text();
                console.log('Raw server response:', responseText);

                // Check if response is HTML error
                if (responseText.trim().startsWith('<') || responseText.includes('<br />') || responseText.includes('<b>')) {
                    console.error('Server returned HTML error:', responseText);

                    // Try to extract error message from HTML
                    const errorMatch = responseText.match(/<b>(.*?)<\/b>/);
                    const errorMessage = errorMatch ? errorMatch[1] : 'Server configuration error';

                    throw new Error(`Server Error: ${errorMessage}`);
                }

                // Try to parse as JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error. Raw response:', responseText.substring(0, 200));
                    throw new Error('Server returned invalid JSON. Please check backend configuration.');
                }

                console.log('Parsed response:', result);

                if (result.success) {
                    alert('✅ Request sent successfully! The book owner will be notified.');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('requestModal'));
                    modal.hide();
                    // Reset form
                    document.getElementById('requestMessage').value = '';
                    document.getElementById('returnDate').value = '';
                } else {
                    throw new Error(result.message || 'Failed to send request');
                }

            } catch (error) {
                console.error('Error submitting request:', error);
                alert('❌ Error: ' + error.message);

                // ✅ SHOW MORE DETAILED ERROR FOR DEBUGGING
                if (error.message.includes('Server Error') || error.message.includes('HTML')) {
                    alert('Backend server error. Please contact administrator or try again later.');
                }
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Request';
                submitBtn.disabled = false;
            }
        }


        // ✅ GET BOOK OWNER ID FUNCTION
        async function getBookOwnerId() {
            try {
                const response = await fetch(`http://localhost/project/backend/api/books/read.php?id=${bookId}`);
                const data = await response.json();
                if (data.books && data.books.length > 0) {
                    return data.books[0].user_id;
                }
                return null;
            } catch (error) {
                console.error('Error getting book owner:', error);
                return null;
            }
        }

        // ✅ MESSAGE OWNER FUNCTION - UPDATE KAREN
        async function messageOwner() {
            if (!currentUserId) {
                alert('Please login to send message');
                window.location.href = 'login.html';
                return;
            }

            try {
                // Check if user is trying to message themselves
                const isOwnBook = await checkIfOwnBookForMessage();

                if (isOwnBook) {
                    alert("You cannot message yourself!");
                    return;
                }

                // Get owner and book details
                const ownerName = document.getElementById('ownerName').textContent;
                const bookTitle = document.getElementById('bookTitle').textContent;

                // Set modal content
                document.getElementById('receiverName').textContent = ownerName;
                document.getElementById('messageBookTitle').textContent = bookTitle;

                // Show modal
                const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
                messageModal.show();

            } catch (error) {
                console.error('Error in messageOwner:', error);
                alert('Error loading book details');
            }
        }

        // ✅ CHECK IF USER'S OWN BOOK (SPECIFIC FOR MESSAGES)
        async function checkIfOwnBookForMessage() {
            try {
                const response = await fetch(`http://localhost/project/backend/api/books/read.php?id=${bookId}`);
                const data = await response.json();

                if (data.books && data.books.length > 0) {
                    const book = data.books[0];
                    return book.user_id == currentUserId;
                }
                return false;
            } catch (error) {
                console.error('Error checking book ownership:', error);
                return false;
            }
        }


        // ✅ CHECK IF USER'S OWN BOOK (Updated for messages)
        async function checkIfOwnBook() {
            try {
                const response = await fetch(`http://localhost/project/backend/api/books/read.php?id=${bookId}`);
                const data = await response.json();

                if (data.books && data.books.length > 0) {
                    const book = data.books[0];
                    if (book.user_id == currentUserId) {
                        alert("You cannot request your own book!");
                        return true;
                    }
                    return false;
                }
                return false;
            } catch (error) {
                console.error('Error checking book ownership:', error);
                alert('Error loading book details');
                return false;
            }
        }

        // ✅ SEND MESSAGE FUNCTION
// ✅ SEND MESSAGE FUNCTION - UPDATED WITH BOOK INFO
async function sendMessage() {
    if (!currentUserId) {
        alert('Please login to send message');
        return;
    }

    const messageText = document.getElementById('messageText').value.trim();
    
    if (!messageText) {
        alert('Please enter your message');
        return;
    }

    // Get receiver ID (book owner)
    const receiverId = await getBookOwnerId();
    if (!receiverId) {
        alert('Could not find book owner');
        return;
    }

    // Get book info
    const bookTitle = document.getElementById('bookTitle').textContent;

    const messageData = {
        sender_id: currentUserId,
        receiver_id: receiverId,
        message_text: `Regarding book "${bookTitle}": ${messageText}`,
        book_id: parseInt(bookId)
    };

    console.log('Sending message:', messageData);

    const sendBtn = document.querySelector('#messageModal .btn-primary');
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
    sendBtn.disabled = true;

    try {
        const response = await fetch('http://localhost/project/backend/api/messages/send.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData)
        });

        const result = await response.json();
        console.log('Message response:', result);

        if (result.success) {
            alert('✅ Message sent successfully!');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('messageModal'));
            modal.hide();
            // Reset form
            document.getElementById('messageText').value = '';
        } else {
            throw new Error(result.message || 'Failed to send message');
        }
        
    } catch (error) {
        console.error('Error sending message:', error);
        alert('❌ Error: ' + error.message);
    } finally {
        sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Message';
        sendBtn.disabled = false;
    }
}




        // ✅ GET BOOK OWNER ID FUNCTION
        async function getBookOwnerId() {
            try {
                const response = await fetch(`http://localhost/project/backend/api/books/read.php?id=${bookId}`);
                const data = await response.json();
                if (data.books && data.books.length > 0) {
                    return data.books[0].user_id;
                }
                return null;
            } catch (error) {
                console.error('Error getting book owner:', error);
                return null;
            }
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '1000';
            toast.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
    `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showError(message) {
            document.querySelector('.book-section').innerHTML = `
        <div class="alert alert-danger text-center m-5">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <br><br>
            <a href="browse-book.html" class="btn btn-warning">
                <i class="fas fa-arrow-left me-1"></i> Back to Browse Books
            </a>
        </div>
    `;
        }

        // ✅ SEND REQUEST FUNCTION - book-details.html mein
        function sendBookRequest(requestType) {
            if (!currentUserId) {
                alert('Please login to send request');
                window.location.href = 'login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('id');

            if (!bookId) {
                alert('Book not found');
                return;
            }

            const message = prompt(`Enter message for ${requestType} request:`);
            if (message === null) return; // User cancelled

            const requestData = {
                book_id: parseInt(bookId),
                user_id: currentUserId, // Use currentUserId here
                request_type: requestType,
                message: message,
                proposed_return_date: requestType === 'Borrow' ?
                    new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : null
            };

            console.log('Sending request:', requestData);

            fetch('http://localhost/project/backend/api/requests/create.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Request response:', data);
                    if (data.success) {
                        alert('✅ Request sent successfully! The book owner will be notified.');
                    } else {
                        alert('❌ Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error sending request:', error);
                    alert('❌ Error sending request. Please try again.');
                });
        }
    </script>
</body>

</html>