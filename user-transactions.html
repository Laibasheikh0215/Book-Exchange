<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Transactions - Book Exchange</title>
    <link rel="website icon" type="png" href="Assets/logo icon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #f3efee;
        }
        .transaction-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .transaction-card:hover {
            transform: translateY(-2px);
        }
        .status-ongoing { border-left: 4px solid #007bff; }
        .status-completed { border-left: 4px solid #28a745; }
        .status-cancelled { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg px-4">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="Assets/main logo.png" alt="main-logo" style="width:150px;">
        </a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-3">
                <li class="nav-item"><a href="browse-book.html" class="nav-link">Browse Books</a></li>
                <li class="nav-item"><a href="my-books.html" class="nav-link">My Book</a></li>
                <li class="nav-item"><a href="user-transactions.html" class="nav-link active">My Transactions</a></li>
            </ul>
            <div class="ms-auto d-flex align-items-center">
                <span class="me-3" id="userWelcome">Welcome, User!</span>
                <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>My Transactions
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Transaction Filters -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary active" onclick="filterTransactions('all')">
                                        All Transactions
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="filterTransactions('ongoing')">
                                        Ongoing
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="filterTransactions('completed')">
                                        Completed
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" onclick="loadUserTransactions()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Transactions List -->
                        <div id="transactionsList">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">Loading your transactions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaction Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionModalBody">
                    <!-- Transaction details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const userData = JSON.parse(localStorage.getItem('user')) || null;

        if (!userData || !userData.loggedIn) {
            alert("Please login first");
            window.location.href = "index.html";
        } else {
            document.getElementById('userWelcome').textContent = `Welcome, ${userData.name}!`;
            loadUserTransactions();
        }

        // Load user transactions
        function loadUserTransactions(filter = 'all') {
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div><p class="mt-2">Loading transactions...</p></div>';

            fetch(`http://localhost/project/backend/api/transactions/get_user_transactions.php?user_id=${userData.user_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayTransactions(data.transactions, filter);
                    } else {
                        transactionsList.innerHTML = `
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-exchange-alt fa-3x mb-3 text-muted"></i>
                                <h5>No Transactions Found</h5>
                                <p class="text-muted">You don't have any transactions yet.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading transactions:', error);
                    transactionsList.innerHTML = `
                        <div class="alert alert-danger text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <h5>Error Loading Transactions</h5>
                            <p>Please try again later.</p>
                            <button class="btn btn-primary mt-2" onclick="loadUserTransactions()">
                                <i class="fas fa-redo me-1"></i>Retry
                            </button>
                        </div>
                    `;
                });
        }

        // Display transactions
        function displayTransactions(transactions, filter = 'all') {
            const transactionsList = document.getElementById('transactionsList');
            
            if (!transactions || transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exchange-alt fa-3x mb-3 text-muted"></i>
                        <h5>No Transactions Found</h5>
                        <p class="text-muted">You don't have any transactions yet.</p>
                    </div>
                `;
                return;
            }

            // Apply filter
            let filteredTransactions = transactions;
            if (filter !== 'all') {
                filteredTransactions = transactions.filter(t => t.status === filter);
            }

            if (filteredTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-filter fa-3x mb-3"></i>
                        <h5>No ${filter} Transactions</h5>
                        <p>You don't have any ${filter} transactions.</p>
                    </div>
                `;
                return;
            }

            transactionsList.innerHTML = filteredTransactions.map(transaction => {
                const isBorrower = parseInt(transaction.borrower_id) === parseInt(userData.user_id);
                const role = isBorrower ? 'Borrower' : 'Lender';
                const otherUser = isBorrower ? transaction.lender_name : transaction.borrower_name;
                const statusClass = `status-${transaction.status}`;
                
                return `
                    <div class="card transaction-card mb-3 ${statusClass}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">${transaction.book_title}</h5>
                                    <p class="card-text">
                                        <strong>Author:</strong> ${transaction.book_author}<br>
                                        <strong>With:</strong> ${otherUser}<br>
                                        <strong>Your Role:</strong> <span class="badge ${isBorrower ? 'bg-info' : 'bg-warning'}">${role}</span><br>
                                        <strong>Type:</strong> <span class="badge bg-secondary">${transaction.request_type}</span>
                                    </p>
                                    <small class="text-muted">
                                        Started: ${new Date(transaction.start_date).toLocaleDateString()}
                                        ${transaction.end_date ? `| Ended: ${new Date(transaction.end_date).toLocaleDateString()}` : ''}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="mb-2">
                                        <span class="badge ${getStatusBadgeClass(transaction.status)}">
                                            ${transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1)}
                                        </span>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetails(${transaction.id})">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                        ${transaction.status === 'ongoing' ? `
                                            <button class="btn btn-sm btn-outline-success" onclick="completeTransaction(${transaction.id})">
                                                <i class="fas fa-check me-1"></i>Complete
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View transaction details
        function viewTransactionDetails(transactionId) {
            fetch(`http://localhost/project/backend/api/transactions/get_transaction_details.php?id=${transactionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showTransactionModal(data.transaction);
                    } else {
                        alert('Error loading transaction details');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading transaction details');
                });
        }

        // Show transaction modal
        function showTransactionModal(transaction) {
            const isBorrower = parseInt(transaction.borrower_id) === parseInt(userData.user_id);
            const role = isBorrower ? 'Borrower' : 'Lender';
            
            const modalBody = document.getElementById('transactionModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Transaction Information</h6>
                        <p><strong>ID:</strong> #${transaction.id}</p>
                        <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(transaction.status)}">${transaction.status}</span></p>
                        <p><strong>Your Role:</strong> <span class="badge ${isBorrower ? 'bg-info' : 'bg-warning'}">${role}</span></p>
                        <p><strong>Type:</strong> ${transaction.request_type}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Timeline</h6>
                        <p><strong>Started:</strong> ${new Date(transaction.start_date).toLocaleString()}</p>
                        ${transaction.end_date ? `<p><strong>Ended:</strong> ${new Date(transaction.end_date).toLocaleString()}</p>` : ''}
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Book Details</h6>
                        <p><strong>Title:</strong> ${transaction.book_title}</p>
                        <p><strong>Author:</strong> ${transaction.book_author}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Parties Involved</h6>
                        <p><strong>Borrower:</strong> ${transaction.borrower_name}</p>
                        <p><strong>Lender:</strong> ${transaction.lender_name}</p>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
            modal.show();
        }

        // Complete transaction
        function completeTransaction(transactionId) {
            if (confirm('Mark this transaction as completed?')) {
                fetch('http://localhost/project/backend/api/transactions/update_transaction_status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transaction_id: transactionId,
                        status: 'completed',
                        notes: 'Transaction marked as completed by user'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Transaction completed successfully!');
                        loadUserTransactions();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error completing transaction');
                });
            }
        }

        // Filter transactions
        function filterTransactions(filter) {
            loadUserTransactions(filter);
            
            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Utility functions
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'ongoing': return 'bg-primary';
                case 'completed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = "index.html";
        }
    </script>
</body>
</html>